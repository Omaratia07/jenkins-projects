pipeline{
    agent any
    tools {
        maven 'maven16'
    }
    stages {
        stage("test_app"){
            steps{
                script{ 
                    echo "Testing The Application"
                    sh '''
                    cd Full-CI-CD-Project
                    mvn test 
                    '''        
                }
            }
        }

        stage("build_jar"){
            steps{
                script{ 
                    echo "Building The Application"
                    sh '''
                    cd Full-CI-CD-Project
                    mvn clean package 
                    '''        
                }
            }
        }
        stage("build_docker_image"){
            steps{
                script{ 
                    echo "Building Docker Image "
                    withCredentials([usernamePassword(credentialsId:'docker-hub-credentials', passwordVariable:'PASSWORD', usernameVariable:'USERNAME' )])
                    {
                    sh 'docker build -t omaralaa87/myapp:1.2 Full-CI-CD-Project/'
                    sh "echo $PASSWORD | docker login -u $USERNAME --password-stdin"
                    }
                }
            }
        }
        stage("push to dockerhub"){
            steps{
                script{ echo "Deploying Application To Dockerhub"
                        sh 'docker push omaralaa87/myapp:1.2'

                }
            }
        }

       stage("DeployApp"){
            steps{
                script{ 
                    echo "Deploying The Application"
                    sshagent(['ec2-ssh']) {
                sh '''
                ssh -o StrictHostKeyChecking=no ubuntu@<54.197.69.234> "
                sudo docker pull omaralaa87/myapp:1.1
                sudo docker run -d -p 8080:8080 --name myapp omaralaa87/myapp:1.1
                
                "
                '''

                
                }
            }
        }

    }




}
